name: Update Starter Kits

on:
  repository_dispatch:
    types: [update-starterkits]
  workflow_dispatch:

permissions: write-all

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          coverage: none

      - run: composer install --prefer-dist --no-interaction --no-progress --no-scripts --ansi

      - name: Fetch and compile starter kits
        run: |
          curl -sL https://raw.githubusercontent.com/jeffersongoncalves/jeffersongoncalves/refs/heads/master/plugins.json -o /tmp/plugins.json

          echo "Starter kits found:"
          jq '[.startkit.featured[], .startkit.legacy[]] | .[].title' /tmp/plugins.json

          php -r '
          $json = json_decode(file_get_contents("/tmp/plugins.json"), true);
          $startkit = $json["startkit"] ?? [];
          $kits = array_merge($startkit["featured"] ?? [], $startkit["legacy"] ?? []);

          // --- Generate config/starterkits.php with single quotes ---
          $lines = ["<?php", "", "return ["];
          foreach ($kits as $kit) {
              $title = str_replace("'"'"'", "\\'"'"'", $kit["title"]);
              $package = str_replace("'"'"'", "\\'"'"'", $kit["package"]);
              $lines[] = "    [";
              $lines[] = "        '"'"'title'"'"' => '"'"'$title'"'"',";
              $lines[] = "        '"'"'package'"'"' => '"'"'$package'"'"',";
              $lines[] = "    ],";
          }
          $lines[] = "];";
          $lines[] = "";
          file_put_contents("config/starterkits.php", implode("\n", $lines));
          echo "Compiled " . count($kits) . " starter kits into config/starterkits.php\n";

          // --- Generate README section ---
          $grouped = [];
          foreach ($kits as $kit) {
              if (preg_match("/v(\d+)$/i", $kit["package"], $m)) {
                  $version = "v" . $m[1];
              } elseif (preg_match("/v(\d+)/i", $kit["title"], $m)) {
                  $version = "v" . $m[1];
              } else {
                  $version = "Other";
              }
              $grouped[$version][] = $kit;
          }

          $md = "## Available Starter Kits\n";
          foreach ($grouped as $version => $items) {
              $md .= "\n### Filament {$version}\n\n";
              $md .= "| Kit | Package |\n";
              $md .= "|-----|--------|\n";
              foreach ($items as $kit) {
                  $md .= "| {$kit["title"]} | \x60{$kit["package"]}\x60 |\n";
              }
          }

          $readme = file_get_contents("README.md");
          $pattern = "/(<!-- STARTERKITS:START -->).*(<!-- STARTERKITS:END -->)/s";
          $replacement = "<!-- STARTERKITS:START -->\n" . trim($md) . "\n<!-- STARTERKITS:END -->";
          $readme = preg_replace($pattern, $replacement, $readme);
          file_put_contents("README.md", $readme);
          echo "Updated README.md starter kits section\n";
          '

      - name: Run Pint to fix code style
        run: ./vendor/bin/pint config/starterkits.php

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet config/starterkits.php README.md; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected!"
            git diff --stat config/starterkits.php README.md
          fi

      - name: Commit changes
        if: steps.changes.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update starter kits list from plugins.json"
          file_pattern: "config/starterkits.php README.md"

      - name: Get latest tag
        if: steps.changes.outputs.changed == 'true'
        id: tag
        uses: "WyriHaximus/github-action-get-previous-tag@v2"
        with:
          fallback: "0.0.0"

      - name: Calculate next version
        if: steps.changes.outputs.changed == 'true'
        id: version
        run: |
          CURRENT="${{ steps.tag.outputs.tag }}"
          CURRENT="${CURRENT#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          NEXT_PATCH=$((PATCH + 1))
          NEXT="v${MAJOR}.${MINOR}.${NEXT_PATCH}"

          # Ensure the version doesn't already exist
          while gh release view "$NEXT" &>/dev/null; do
            NEXT_PATCH=$((NEXT_PATCH + 1))
            NEXT="v${MAJOR}.${MINOR}.${NEXT_PATCH}"
          done

          echo "next=$NEXT" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        if: steps.changes.outputs.changed == 'true'
        run: |
          gh release create ${{ steps.version.outputs.next }} \
            --title "${{ steps.version.outputs.next }}" \
            --notes "Automated release: starter kits list updated." \
            --target main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger PHAR build
        if: steps.changes.outputs.changed == 'true'
        run: gh workflow run publish-phar.yml -f tag_name=${{ steps.version.outputs.next }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
