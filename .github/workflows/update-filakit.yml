name: Update Starter Kits

on:
  repository_dispatch:
    types: [update-starterkits]
  workflow_dispatch:

permissions: write-all

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          coverage: none

      - name: Fetch and compile starter kits
        run: |
          curl -sL https://raw.githubusercontent.com/jeffersongoncalves/jeffersongoncalves/refs/heads/master/plugins.json -o /tmp/plugins.json

          echo "Starter kits found:"
          jq '.startkit[] | .title' /tmp/plugins.json

          php -r '
          $json = json_decode(file_get_contents("/tmp/plugins.json"), true);
          $kits = $json["startkit"] ?? [];

          $lines = ["<?php", "", "return ["];
          foreach ($kits as $kit) {
              $title = addslashes($kit["title"]);
              $package = addslashes($kit["package"]);
              $lines[] = "    [";
              $lines[] = "        \"title\" => \"$title\",";
              $lines[] = "        \"package\" => \"$package\",";
              $lines[] = "    ],";
          }
          $lines[] = "];";
          $lines[] = "";

          file_put_contents("config/starterkits.php", implode("\n", $lines));
          echo "Compiled " . count($kits) . " starter kits into config/starterkits.php\n";
          '

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet config/starterkits.php; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected!"
            git diff config/starterkits.php
          fi

      - name: Commit changes
        if: steps.changes.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update starter kits list from plugins.json"
          file_pattern: config/starterkits.php

      - name: Get latest tag
        if: steps.changes.outputs.changed == 'true'
        id: tag
        uses: "WyriHaximus/github-action-get-previous-tag@v2"
        with:
          fallback: "0.0.0"

      - name: Calculate next version
        if: steps.changes.outputs.changed == 'true'
        id: version
        run: |
          CURRENT="${{ steps.tag.outputs.tag }}"
          CURRENT="${CURRENT#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          PATCH=$((PATCH + 1))
          echo "next=v${MAJOR}.${MINOR}.${PATCH}" >> "$GITHUB_OUTPUT"

      - name: Create Release
        if: steps.changes.outputs.changed == 'true'
        run: |
          gh release create ${{ steps.version.outputs.next }} \
            --title "${{ steps.version.outputs.next }}" \
            --notes "Automated release: starter kits list updated." \
            --target main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
